# Настройка push-уведомлений

Чтобы push-уведомления в PWA заработали, необходимо подготовить серверную часть и
переменные окружения.

## 1. Установите зависимость `web-push`

```bash
npm install web-push
```

Без этой библиотеки сервер не сможет отправлять push-сообщения и будет лишь
сохранять уведомления в базе.

## 2. Сгенерируйте пару VAPID-ключей

```bash
npx web-push generate-vapid-keys
```

Команда выведет открытый и приватный ключи. Сохраните их — они понадобятся для
переменных окружения.

## 3. Пропишите переменные окружения

В файле `.env.local` (или в переменных окружения хостинга) укажите значения:

```ini
WEB_PUSH_PUBLIC_KEY=<публичный ключ из предыдущего шага>
WEB_PUSH_PRIVATE_KEY=<приватный ключ>
WEB_PUSH_CONTACT=mailto:admin@example.com
```

`WEB_PUSH_CONTACT` должен быть либо email с префиксом `mailto:`, либо ссылка на
контактную страницу. Этот адрес будет передан в заголовках push-сообщений.

> ℹ️ Если в инфраструктуре уже используется переменная `WEB_PUSH_CONTACT_EMAIL`,
> её можно задать вместо `WEB_PUSH_CONTACT` — сервер поддерживает оба варианта и
> при необходимости автоматически добавит префикс `mailto:`.

Если вы публикуете публичный ключ на клиенте под другим именем, также можно
добавить `NEXT_PUBLIC_WEB_PUSH_PUBLIC_KEY` — он должен совпадать с
`WEB_PUSH_PUBLIC_KEY`.

## 4. Перезапустите сервер

После изменения переменных окружения перезапустите Next.js-приложение. При
успешной конфигурации карточка уведомлений перестанет показывать сообщение о
необходимости настройки сервера, а пользователи смогут включить push-оповещения.

## 5. (Необязательно) Проверьте доступность сервис-воркера

Убедитесь, что сервис-воркер PWA активен и в консоли браузера нет ошибок.
Подписку можно проверить через DevTools → Application → Push Messaging.

## 6. Push-уведомления на телефонах

Чтобы сообщения действительно появлялись как системные push-уведомления на
смартфоне, понадобится выполнить несколько условий:

- PWA должна быть установлена на устройство (добавлена на домашний экран в
  Android/Chrome или через «Поделиться → На экран Домой» в Safari на iOS).
- Пользователь должен выдать разрешение на показ уведомлений. После установки
  приложения запрос можно инициировать из карточки «Уведомления» в личном
  кабинете.
- Устройство должно быть подключено к сети — как только сервер отправит push,
  сервис-воркер разбудится и покажет сообщение. На Android уведомление придёт
  даже при закрытом браузере; на iOS поддержка работает, начиная с версии
  16.4, и требуется установка веб-приложения на главный экран.
- Сервер должен иметь корректно настроенные VAPID-ключи и контактные данные
  (шаги 1–4 выше). Если конфигурация нарушена, фронтенд покажет предупреждение
  «Push-уведомления выключены на стороне сервера».

Для отладки можно включить расширенные логи в консоли браузера командой
`window.__aqPushDebug.enable(true)` и посмотреть состояние подписки через
`window.__aqPushDebug.logSnapshot()`.

